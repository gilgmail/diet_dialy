// Sync status indicator component
'use client';

import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { useMedicalData } from '@/lib/google';
import { unifiedDataService } from '@/lib/unified-data-service';
import { offlineStorageManager } from '@/lib/offline-storage';
import {
  Wifi,
  WifiOff,
  RefreshCw,
  CheckCircle,
  AlertCircle,
  Clock,
  Database,
  CloudOff,
  Activity,
  Zap
} from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';

interface SyncStatusProps {
  className?: string;
  showDetails?: boolean;
  compact?: boolean;
}

interface DetailedSyncStatus {
  isOnline: boolean;
  isAuthenticated: boolean;
  hasValidConnection: boolean;
  pendingCount: number;
  errorCount: number;
  lastSyncTime: Date | null;
  isSyncing: boolean;
  connectionQuality: 'excellent' | 'good' | 'poor' | 'offline';
  lastError?: string;
}

export function SyncStatus({
  className = '',
  showDetails = true,
  compact = false
}: SyncStatusProps) {
  const { syncStatus, syncNow, isAuthenticated, isReady, medicalService, signIn } = useMedicalData();
  const [isManualSyncing, setIsManualSyncing] = useState(false);
  const [isReconnecting, setIsReconnecting] = useState(false);
  const [detailedStatus, setDetailedStatus] = useState<DetailedSyncStatus>({
    isOnline: navigator.onLine,
    isAuthenticated: false,
    hasValidConnection: false,
    pendingCount: 0,
    errorCount: 0,
    lastSyncTime: null,
    isSyncing: false,
    connectionQuality: 'offline'
  });

  // ÂØ¶ÊôÇÊõ¥Êñ∞Ë©≥Á¥∞ÁãÄÊÖã
  useEffect(() => {
    const updateDetailedStatus = () => {
      const stats = unifiedDataService.getStatistics();
      const syncMetadata = offlineStorageManager.getSyncMetadata();
      const hasValidConnection = navigator.onLine && isAuthenticated && isReady;

      // Ë®àÁÆóÈÄ£Êé•Ë≥™Èáè
      let connectionQuality: DetailedSyncStatus['connectionQuality'] = 'offline';
      if (navigator.onLine) {
        if (isAuthenticated && isReady) {
          connectionQuality = stats.errorCount === 0 ? 'excellent' : 'good';
        } else {
          connectionQuality = 'poor';
        }
      }

      setDetailedStatus({
        isOnline: navigator.onLine,
        isAuthenticated,
        hasValidConnection,
        pendingCount: stats.pendingCount,
        errorCount: stats.errorCount,
        lastSyncTime: syncMetadata.lastSyncTime ? new Date(syncMetadata.lastSyncTime) : null,
        isSyncing: isManualSyncing || syncStatus?.syncInProgress || false,
        connectionQuality,
        lastError: stats.errorCount > 0 ? 'ÈÉ®ÂàÜË®òÈåÑÂêåÊ≠•Â§±Êïó' : undefined
      });
    };

    // Á´ãÂç≥Êõ¥Êñ∞‰∏ÄÊ¨°
    updateDetailedStatus();

    // ÂÆöÊúüÊõ¥Êñ∞ÁãÄÊÖã
    const interval = setInterval(updateDetailedStatus, 5000);

    // Áõ£ËÅΩÁ∂≤Ë∑ØÁãÄÊÖãËÆäÂåñ
    const handleOnline = () => updateDetailedStatus();
    const handleOffline = () => updateDetailedStatus();

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      clearInterval(interval);
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, [isAuthenticated, isReady, isManualSyncing, syncStatus]);

  const handleManualSync = async () => {
    if (isManualSyncing || !detailedStatus.hasValidConnection) return;

    setIsManualSyncing(true);
    try {
      console.log('üîÑ ÈñãÂßãÊâãÂãïÂêåÊ≠•...');

      if (medicalService) {
        const result = await unifiedDataService.syncPendingEntries(medicalService);
        console.log('‚úÖ ÊâãÂãïÂêåÊ≠•ÁµêÊûú:', result);

        // È°ØÁ§∫ÂêåÊ≠•ÁµêÊûú
        if (result.failed === 0) {
          showToast(`‚úÖ ÂêåÊ≠•ÂÆåÊàê: ${result.success} Á≠ÜË®òÈåÑ`);
        } else {
          showToast(`‚ö†Ô∏è ÈÉ®ÂàÜÂêåÊ≠•: ${result.success} ÊàêÂäü, ${result.failed} Â§±Êïó`);
        }
      } else {
        await syncNow();
      }
    } catch (error) {
      console.error('‚ùå ÊâãÂãïÂêåÊ≠•Â§±Êïó:', error);
      showToast('‚ùå ÂêåÊ≠•Â§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑ö');
    } finally {
      setIsManualSyncing(false);
    }
  };

  // Á∞°ÂñÆÁöÑtoastÊèêÁ§∫ÂáΩÊï∏
  const showToast = (message: string) => {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed; top: 20px; right: 20px; background: #059669; color: white;
      padding: 12px 16px; border-radius: 8px; z-index: 1000; font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 300px;
    `;
    if (message.startsWith('‚ùå') || message.startsWith('‚ö†Ô∏è')) {
      toast.style.background = '#dc2626';
    }
    document.body.appendChild(toast);
    setTimeout(() => toast.parentNode?.removeChild(toast), 3000);
  };

  const getStatusIcon = () => {
    if (!detailedStatus.isOnline) {
      return <WifiOff className="w-4 h-4 text-red-500" />;
    }

    if (detailedStatus.isSyncing) {
      return <RefreshCw className="w-4 h-4 text-blue-500 animate-spin" />;
    }

    if (detailedStatus.errorCount > 0) {
      return <AlertCircle className="w-4 h-4 text-yellow-500" />;
    }

    if (detailedStatus.pendingCount > 0) {
      return <Clock className="w-4 h-4 text-orange-500" />;
    }

    if (detailedStatus.hasValidConnection) {
      return <CheckCircle className="w-4 h-4 text-green-500" />;
    }

    return <WifiOff className="w-4 h-4 text-gray-500" />;
  };

  // Ëá™ÂãïÈáçÈÄ£ÂäüËÉΩ
  const handleAutoReconnect = async () => {
    if (isReconnecting || !detailedStatus.isOnline) return;

    setIsReconnecting(true);
    try {
      console.log('üîÑ ÂòóË©¶Ëá™ÂãïÈáçÊñ∞ÈÄ£Êé•Âà∞ Google...');
      const authUrl = await signIn();

      // Âú®Êñ∞Á™óÂè£‰∏≠ÊâìÈñãË™çË≠âÈ†ÅÈù¢
      const authWindow = window.open(
        authUrl,
        'google-auth',
        'width=500,height=600,scrollbars=yes,resizable=yes'
      );

      if (authWindow) {
        // Áõ£ËÅΩÁ™óÂè£ÈóúÈñâ‰∫ã‰ª∂
        const checkClosed = setInterval(() => {
          if (authWindow.closed) {
            clearInterval(checkClosed);
            setIsReconnecting(false);

            // Ê™¢Êü•Ë™çË≠âÊòØÂê¶ÊàêÂäü
            setTimeout(() => {
              if (isAuthenticated) {
                showToast('‚úÖ ÈáçÊñ∞ÈÄ£Êé•ÊàêÂäü');
              } else {
                showToast('‚ÑπÔ∏è Ë´ãÂÆåÊàê Google Ë™çË≠â‰ª•ÁπºÁ∫åÂêåÊ≠•');
              }
            }, 1000);
          }
        }, 1000);
      } else {
        showToast('‚ùå ÁÑ°Ê≥ïÊâìÈñãË™çË≠âÁ™óÂè£ÔºåË´ãÊ™¢Êü•ÂΩàÁ™óÊîîÊà™Ë®≠ÂÆö');
        setIsReconnecting(false);
      }
    } catch (error) {
      console.error('‚ùå Ëá™ÂãïÈáçÈÄ£Â§±Êïó:', error);
      showToast('‚ùå Ëá™ÂãïÈáçÈÄ£Â§±ÊïóÔºåË´ãÊâãÂãïÈáçÊñ∞ÁôªÂÖ•');
      setIsReconnecting(false);
    }
  };

  const getStatusText = () => {
    if (!detailedStatus.isOnline) {
      return 'Èõ¢Á∑ö';
    }

    if (isReconnecting) {
      return 'Ê≠£Âú®ÈáçÊñ∞ÈÄ£Êé•...';
    }

    if (!detailedStatus.isAuthenticated) {
      return 'Êú™ÈÄ£Êé• - ÈªûÊìäÈáçÊñ∞ÈÄ£Êé•';
    }

    if (detailedStatus.isSyncing) {
      return 'ÂêåÊ≠•‰∏≠...';
    }

    if (!isReady) {
      return 'ÊúçÂãôÂàùÂßãÂåñ‰∏≠';
    }

    if (detailedStatus.errorCount > 0) {
      return `${detailedStatus.errorCount} È†ÖÂêåÊ≠•Â§±Êïó`;
    }

    if (detailedStatus.pendingCount > 0) {
      return `${detailedStatus.pendingCount} È†ÖÂæÖÂêåÊ≠•`;
    }

    if (detailedStatus.lastSyncTime) {
      try {
        return `Â∑≤ÂêåÊ≠• ${formatDistanceToNow(detailedStatus.lastSyncTime, { addSuffix: true })}`;
      } catch {
        return 'Â∑≤ÂêåÊ≠•';
      }
    }

    if (detailedStatus.hasValidConnection) {
      return 'ÈÄ£Êé•Ê≠£Â∏∏';
    }

    return 'Á≠âÂæÖÈÄ£Êé•';
  };

  const getStatusColor = () => {
    if (!detailedStatus.isOnline) {
      return 'text-red-600';
    }

    if (!detailedStatus.isAuthenticated || !isReady) {
      return 'text-yellow-600';
    }

    if (detailedStatus.isSyncing) {
      return 'text-blue-600';
    }

    if (detailedStatus.errorCount > 0) {
      return 'text-yellow-600';
    }

    if (detailedStatus.pendingCount > 0) {
      return 'text-orange-600';
    }

    if (detailedStatus.hasValidConnection) {
      return 'text-green-600';
    }

    return 'text-gray-600';
  };

  // Á∑äÊπäÊ®°ÂºèÊ∏≤Êüì
  if (compact) {
    return (
      <div className={`flex items-center space-x-2 ${className}`}>
        {getStatusIcon()}
        <span className={`text-sm ${getStatusColor()}`}>
          {getStatusText()}
        </span>
        {detailedStatus.pendingCount > 0 && (
          <Badge variant="outline" className="text-xs">
            {detailedStatus.pendingCount}
          </Badge>
        )}
      </div>
    );
  }

  if (!showDetails) {
    return (
      <div className={`flex items-center space-x-2 ${className}`}>
        {getStatusIcon()}
        <span className={`text-sm ${getStatusColor()}`}>
          {getStatusText()}
        </span>
        {detailedStatus.pendingCount > 0 && (
          <Badge variant="outline" className="text-xs">
            {detailedStatus.pendingCount}
          </Badge>
        )}
      </div>
    );
  }

  return (
    <div className={`bg-white border rounded-lg p-4 ${className}`}>
      <div className="flex items-center justify-between mb-3">
        <h3 className="text-sm font-medium text-gray-900 flex items-center space-x-2">
          <Database className="w-4 h-4" />
          <span>Êï∏ÊìöÂêåÊ≠•ÁãÄÊÖã</span>
        </h3>
        
        <Button
          onClick={handleManualSync}
          variant="outline"
          size="sm"
          disabled={!detailedStatus.hasValidConnection || detailedStatus.isSyncing}
          className={`flex items-center space-x-1 ${
            detailedStatus.pendingCount > 0 ? 'border-blue-300 text-blue-700 hover:bg-blue-50' : ''
          }`}
        >
          <RefreshCw className={`w-3 h-3 ${detailedStatus.isSyncing ? 'animate-spin' : ''}`} />
          <span>{detailedStatus.pendingCount > 0 ? `ÂêåÊ≠• (${detailedStatus.pendingCount})` : 'ÂêåÊ≠•'}</span>
        </Button>
      </div>
      
      {/* Main Status */}
      <div className="flex items-center space-x-3 mb-3">
        {getStatusIcon()}
        <div className="flex-1">
          <div
            className={`text-sm font-medium ${getStatusColor()} ${
              !detailedStatus.isAuthenticated && detailedStatus.isOnline
                ? 'cursor-pointer hover:underline'
                : ''
            }`}
            onClick={!detailedStatus.isAuthenticated && detailedStatus.isOnline ? handleAutoReconnect : undefined}
          >
            {getStatusText()}
          </div>
          {syncStatus.error && (
            <div className="text-xs text-red-500 mt-1">
              {syncStatus.error}
            </div>
          )}
        </div>
      </div>
      
      {/* Detailed Connection Status */}
      <div className="grid grid-cols-2 gap-4 text-xs text-gray-600">
        <div className="flex items-center space-x-2">
          {detailedStatus.connectionQuality === 'excellent' ? (
            <Zap className="w-3 h-3 text-green-500" title="ÈÄ£Êé•ÂìÅË≥™ÂÑ™ÁßÄ" />
          ) : detailedStatus.connectionQuality === 'good' ? (
            <Wifi className="w-3 h-3 text-green-500" title="ÈÄ£Êé•ÂìÅË≥™ËâØÂ•Ω" />
          ) : detailedStatus.connectionQuality === 'poor' ? (
            <AlertCircle className="w-3 h-3 text-yellow-500" title="ÈÄ£Êé•ÂìÅË≥™ËºÉÂ∑Æ" />
          ) : (
            <CloudOff className="w-3 h-3 text-red-500" title="Èõ¢Á∑ö" />
          )}
          <span>
            {detailedStatus.connectionQuality === 'excellent' ? 'ÈÄ£Êé•ÂÑ™ÁßÄ' :
             detailedStatus.connectionQuality === 'good' ? 'ÈÄ£Êé•ËâØÂ•Ω' :
             detailedStatus.connectionQuality === 'poor' ? 'ÈÄ£Êé•‰∏çÁ©©' : 'Èõ¢Á∑ö'}
          </span>
        </div>

        <div className="flex items-center space-x-2">
          <Clock className="w-3 h-3" />
          <span>
            {detailedStatus.lastSyncTime ? (
              `‰∏äÊ¨°: ${detailedStatus.lastSyncTime.toLocaleTimeString()}`
            ) : (
              'ÂæûÊú™ÂêåÊ≠•'
            )}
          </span>
        </div>
      </div>
      
      {/* Pending Changes */}
      {detailedStatus.pendingCount > 0 && (
        <div className="mt-3 p-2 bg-orange-50 border border-orange-200 rounded text-xs">
          <div className="flex items-center space-x-2 text-orange-700">
            <Clock className="w-3 h-3" />
            <span>
              {detailedStatus.pendingCount} È†ÖÁõÆÁ≠âÂæÖÂêåÊ≠•„ÄÇ
              {detailedStatus.hasValidConnection ?
                'Â∞áËá™ÂãïÂêåÊ≠•„ÄÇ' :
                detailedStatus.isOnline ?
                  'Ë´ãÂÖàÁôªÂÖ• Google Â∏≥Ëôü„ÄÇ' :
                  'ÊÅ¢Âæ©Á∂≤Ë∑ØÈÄ£Êé•ÂæåÂ∞áÂêåÊ≠•„ÄÇ'
              }
            </span>
          </div>
        </div>
      )}

      {/* Sync Errors */}
      {detailedStatus.errorCount > 0 && (
        <div className="mt-3 p-2 bg-red-50 border border-red-200 rounded text-xs">
          <div className="flex items-center justify-between text-red-700">
            <div className="flex items-center space-x-2">
              <AlertCircle className="w-3 h-3" />
              <span>
                {detailedStatus.errorCount} È†ÖÁõÆÂêåÊ≠•Â§±Êïó„ÄÇ
                {detailedStatus.lastError && ` ÈåØË™§: ${detailedStatus.lastError}`}
              </span>
            </div>
            <Button
              onClick={handleManualSync}
              variant="ghost"
              size="sm"
              className="h-6 px-2 text-red-700 hover:bg-red-100"
              disabled={detailedStatus.isSyncing || !detailedStatus.hasValidConnection}
            >
              ÈáçË©¶
            </Button>
          </div>
        </div>
      )}
      
      {/* Status Summary and Privacy Notice */}
      {detailedStatus.hasValidConnection && detailedStatus.pendingCount === 0 && detailedStatus.errorCount === 0 && (
        <div className="mt-3 p-2 bg-green-50 border border-green-200 rounded text-xs text-green-700">
          <div className="flex items-center space-x-2">
            <CheckCircle className="w-3 h-3" />
            <span>ÊâÄÊúâË®òÈåÑÂ∑≤ÂêåÊ≠•ÂÆåÊàê„ÄÇ</span>
          </div>
        </div>
      )}

      <div className="mt-3 p-2 bg-blue-50 border border-blue-200 rounded text-xs text-blue-700">
        <div className="flex items-start space-x-2">
          <Database className="w-3 h-3 mt-0.5" />
          <span>
            ÊÇ®ÁöÑÂÅ•Â∫∑Êï∏ÊìöÂÆâÂÖ®Â≠òÂÑ≤Âú®ÊÇ®ÁöÑ Google Â∏≥Êà∂‰∏≠„ÄÇ
            ÊàëÂÄëÁµï‰∏çÊúÉÂú®ÊàëÂÄëÁöÑ‰º∫ÊúçÂô®‰∏äÂ≠òÂÑ≤ÊÇ®ÁöÑÂÅ•Â∫∑‰ø°ÊÅØ„ÄÇ
          </span>
        </div>
      </div>
    </div>
  );
}

export default SyncStatus;
# 最終同步測試指南

## ✅ 已修復的問題

### 1. `[object Object]` 顯示問題
- **修復**: 添加數據格式轉換邏輯
- **位置**: `src/lib/google/index.ts:178-186`

### 2. 測試數據污染問題
- **修復**: 完全禁用智能同步服務
- **位置**: `src/lib/google/index.ts:46-54`

### 3. 認證問題
- **修復**: 在同步前自動刷新認證令牌
- **位置**: `src/lib/google/index.ts:162-173`

## 🧪 測試步驟

### 步驟 1: 清理環境
```javascript
// 在瀏覽器控制台運行
localStorage.clear();
location.reload();
```

### 步驟 2: 重新認證
1. 前往 http://localhost:3000/auth
2. 點擊「使用 Google 登入」
3. 完成 Google 授權流程
4. 確認看到「認證成功」訊息

### 步驟 3: 測試同步
1. 前往 http://localhost:3000/food-diary
2. 按 **F12** 打開開發者工具
3. 切換到 **Console** 標籤頁
4. 添加一筆新食物記錄（例如：蘋果）

### 步驟 4: 觀察日誌
**預期控制台輸出**:
```
📤 嘗試直接同步到Google Sheets...
📝 原始食物資料: { foodData: { name_zh: "蘋果", category: "水果" }, ... }
🔑 檢查並刷新認證令牌...
✅ 認證令牌刷新成功
📊 初始化 Google Sheets...
📊 轉換後的 Sheets 格式: { foodName: "蘋果", category: "水果", ... }
✅ Google Sheets 同步成功: true
```

### 步驟 5: 驗證 Google Sheets
1. 檢查 Google Sheets 中的新記錄
2. 確認食物名稱顯示為 `蘋果`（不是 `[object Object]`）
3. 確認沒有 "migrated" 標記的測試數據

## 🔍 故障排除

### 如果看到認證錯誤
```
❌ 令牌刷新發生錯誤: [錯誤訊息]
```
**解決方法**:
1. 清除 localStorage
2. 重新進行 Google 登入
3. 確認授權所有必要權限

### 如果看到初始化錯誤
```
❌ 初始化醫療資料服務失敗: [錯誤訊息]
```
**解決方法**:
1. 檢查網路連接
2. 確認 Google Sheets API 配額
3. 重新整理頁面

### 如果仍看到測試數據
**表示**: 智能同步可能未完全禁用
**檢查**: 控制台應該顯示 `🚫 智能同步已禁用（調試模式）`

## 📊 成功標準

✅ **數據格式正確**: Google Sheets 顯示正確食物名稱
✅ **同步完整**: 本地記錄數量 = Google Sheets 記錄數量
✅ **無測試污染**: 沒有 "migrated" 或舊的測試數據
✅ **認證穩定**: 令牌自動刷新成功

## 🔄 如果仍有問題

請提供：
1. 完整的控制台錯誤訊息
2. Google Sheets 中顯示的具體內容
3. 網路狀態（線上/離線）
4. 認證狀態（已登入/未登入）

---

**測試狀態**: ✅ 就緒
**預期結果**: 完整、正確的 Google Sheets 同步
**下一步**: 用戶驗證修復效果

*更新時間: 2025-09-19 10:50*